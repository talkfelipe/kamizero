<div class="container notice-page">
  <!-- PAGE HEADER: BACK + TITLE + SUBTITLE -->
  <div class="notice-header">
    <%= link_to dashboard_path, class: "text-decoration-none text-secondary" do %>
      <i class="fa-solid fa-angles-left"></i> <strong>BACK</strong>
    <% end %>
    <h2>Create New Notice</h2>
    <p>Send a New Notice to Parents <i class="fa-solid fa-angles-down"></i></p>
  </div>
  <!-- FORM CARD -->
  <div class="notice-card">
    <ul class="nav nav-tabs mb-3 border-0" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="btn btn-primary mx-3 text-white" id="home-tab" data-bs-toggle="tab" data-bs-target="#home-tab-pane" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">Create from uploaded file</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="btn btn-primary mx-3 text-white" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-tab-pane" type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="false">Create from blank form</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="btn btn-primary mx-3 text-white" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact-tab-pane" type="button" role="tab" aria-controls="contact-tab-pane" aria-selected="false">Create from a template</button>
      </li>
    </ul>
  </div>
  <div class="notice-card">
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab" tabindex="0">
        <%= simple_form_for @notice, html: { id: "notice-upload-form", data: { controller: "conditional-form document-upload" } } do |f| %>
          <div class="position-relative">
            <%= f.input :attachment,
                    as: :file,
                    label: "Add Attachment",
                    input_html: { data: { action: "change->document-upload#handleFileChange", "document-upload-target": "fileInput" } } %>
            <div class="spinner-overlay d-none" data-document-upload-target="spinner">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Processing...</span>
              </div>
              <span class="ms-2">Processing attachment...</span>
            </div>
          </div>
          <div class="d-none" data-document-upload-target="formFields">
            <%= f.input :category,
                    collection: Notice::CATEGORIES,
                    input_html: {
                      data: {
                        "conditional-form-target" => "selector",
                        action: "change->conditional-form#toggleDependentField"
                      }
                    } %>
            <div data-conditional-form-target="dependentField"
            data-show-if="Event"
            class="hidden">
              <%= f.input :date,
                      as: :string,
                      placeholder: "yyyy/mm/dd",
                      input_html: { data: { controller: "flatpickr" } } %>
              <div class="row">
                <div class="col-6">
                  <%= f.input :start_time,
                          as: :string,
                          placeholder: "10:30:00",
                          input_html: { data: { controller: "timepicker" } } %>
                </div>
                <div class="col-6">
                  <%= f.input :end_time,
                          as: :string,
                          placeholder: "11:30:00",
                          input_html: { data: { controller: "timepicker" } } %>
                </div>
              </div>
            </div>
            <%= f.association :classroom, collection: [["ALL", ""]] + @school.classrooms.map{|classroom| ["#{classroom.grade}#{classroom.name}", classroom.id]}, include_blank: false %>
            <%= f.input :title,
                    placeholder: "e.g., Sports day",
                    input_html: { data: { "document-upload-target": "title" } } %>
            <!-- Content input (label + textarea kept for manual entry) -->
            <%= f.input :content,
                    placeholder: "Enter the full notice comment here...",
                    input_html: {
                      style: "height: 300px;",
                      data: { "document-upload-target": "content" }
                    } %>
            <!-- Clean HTML preview, shown after auto-fill (textarea will be hidden by JS) -->
            <div class="mt-3 d-none notice-content-preview"
            data-document-upload-target="contentPreview"></div>
            <div class="d-flex justify-content-end m-3">
              <%= link_to "Cancel", dashboard_path, class: "btn btn-light me-2" %>
              <%= f.button :submit, class: "btn btn-dark" %>
            </div>
          </div>
          <!-- Image/PDF preview (hidden until content is generated) -->
          <div class="d-none" data-document-upload-target="previewContainer">
            <img src=""
            data-document-upload-target="preview"
            style="max-width: 100%; height: auto; border-radius: 10px; border: 1px solid #d0d7de;">
          </div>
        <% end %>
      </div>
      <div class="tab-pane fade" id="profile-tab-pane" role="tabpanel" aria-labelledby="profile-tab" tabindex="0">
        <%= simple_form_for @notice, html: { id: "notice-blank-form", data: { controller: "conditional-form" } } do |f| %>
          <%= f.input :category,
                    collection: Notice::CATEGORIES,
                    input_html: {
                      data: {
                        "conditional-form-target" => "selector",
                        action: "change->conditional-form#toggleDependentField"
                      }
                    } %>
          <div data-conditional-form-target="dependentField"
            data-show-if="Event"
            class="hidden">
            <%= f.input :date,
                      as: :string,
                      placeholder: "yyyy/mm/dd",
                      input_html: { data: { controller: "flatpickr" } } %>
            <div class="row">
              <div class="col-6">
                <%= f.input :start_time,
                          as: :string,
                          placeholder: "10:30:00",
                          input_html: { data: { controller: "timepicker" } } %>
              </div>
              <div class="col-6">
                <%= f.input :end_time,
                          as: :string,
                          placeholder: "11:30:00",
                          input_html: { data: { controller: "timepicker" } } %>
              </div>
            </div>
          </div>
          <%= f.association :classroom, collection: [["ALL", ""]] + @school.classrooms.map{|classroom| ["#{classroom.grade}#{classroom.name}", classroom.id]}, include_blank: false %>
          <%= f.input :title, placeholder: "e.g., Sports day" %>
          <!-- Content input (label + textarea kept for manual entry) -->
          <%= f.input :content,
                  placeholder: "Enter the full notice comment here...",
                  input_html: { style: "height: 300px;" } %>
          <div class="d-flex justify-content-end m-3">
            <%= link_to "Cancel", dashboard_path, class: "btn btn-light me-2" %>
            <%= f.button :submit, class: "btn btn-dark" %>
          </div>
        <% end %>
      </div>
      <div class="tab-pane fade" id="contact-tab-pane" role="tabpanel" aria-labelledby="contact-tab" tabindex="0">
      </div>
    </div>
  </div>
</div>
