<div class="container notice-page">
  <!-- PAGE HEADER: BACK + TITLE + SUBTITLE -->
  <div class="notice-header">
    <%= link_to dashboard_path, class: "text-decoration-none text-secondary" do %>
      <i class="fa-solid fa-angles-left"></i> <strong>BACK</strong>
    <% end %>
    <h2>Create New Notice</h2>
    <p>Send a New Notice to Parents <i class="fa-solid fa-angles-down"></i></p>
  </div>
  <!-- FORM CARD -->
  <div class="notice-card">
    <ul class="nav nav-tabs mb-3 border-0" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="btn btn-primary mx-3 text-white" id="home-tab" data-bs-toggle="tab" data-bs-target="#home-tab-pane" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">Create from uploaded file</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="btn btn-primary mx-3 text-white" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-tab-pane" type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="false">Create from blank form</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="btn btn-primary mx-3 text-white" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact-tab-pane" type="button" role="tab" aria-controls="contact-tab-pane" aria-selected="false">Create from a template</button>
      </li>
    </ul>
  </div>
  <div class="notice-card">
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab" tabindex="0">
        <%= simple_form_for @notice, html: { id: "notice-upload-form", data: { controller: "conditional-form document-upload" } } do |f| %>
          <div class="position-relative">
            <%= f.input :attachment,
                    as: :file,
                    label: "Add Attachment",
                    input_html: { data: { action: "change->document-upload#handleFileChange", "document-upload-target": "fileInput" } } %>
            <div class="spinner-overlay d-none" data-document-upload-target="spinner">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Processing...</span>
              </div>
              <span class="ms-2">Processing attachment...</span>
            </div>
          </div>
          <div class="d-none" data-document-upload-target="formFields">
            <%= render "form_fields", f: f,
                title_data: { data: { "document-upload-target": "title" } },
                content_data: { data: { "document-upload-target": "content" } },
                content_preview: true %>
          </div>
          <!-- Image/PDF preview (hidden until content is generated) -->
          <div class="d-none" data-document-upload-target="previewContainer">
            <img src=""
            data-document-upload-target="preview"
            style="max-width: 100%; height: auto; border-radius: 10px; border: 1px solid #d0d7de;">
          </div>
        <% end %>
      </div>
      <div class="tab-pane fade" id="profile-tab-pane" role="tabpanel" aria-labelledby="profile-tab" tabindex="0">
        <%= simple_form_for @notice, html: { id: "notice-blank-form", data: { controller: "conditional-form" } } do |f| %>
          <%= render "form_fields", f: f %>
        <% end %>
      </div>
      <div class="tab-pane fade" id="contact-tab-pane" role="tabpanel" aria-labelledby="contact-tab" tabindex="0">
        <p class="text-muted mb-4">Select a template below to pre-fill the form with content you can customize.</p>
        <div class="row">
          <% @templates.each do |template| %>
            <div class="col-md-6 mb-3">
              <div class="card h-100">
                <div class="card-body">
                  <span class="badge <%= template.category == 'Event' ? 'bg-warning' : 'bg-secondary' %> mb-2"><%= template.category %></span>
                  <h5 class="card-title"><%= template.title %></h5>
                  <p class="card-text text-muted small"><%= truncate(template.content, length: 100) %></p>
                </div>
                <div class="card-footer bg-transparent border-0">
                  <button type="button"
                          class="btn btn-dark btn-sm w-100 use-template-btn"
                          data-category="<%= template.category %>"
                          data-title="<%= template.title %>"
                          data-content="<%= template.content %>">
                    Use this template
                  </button>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".use-template-btn").forEach(function(button) {
      button.addEventListener("click", function() {
        const category = this.dataset.category;
        const title = this.dataset.title;
        const content = this.dataset.content;

        const blankForm = document.getElementById("notice-blank-form");
        if (!blankForm) return;

        const categorySelect = blankForm.querySelector("select[name='notice[category]']");
        const titleInput = blankForm.querySelector("input[name='notice[title]']");
        const contentTextarea = blankForm.querySelector("textarea[name='notice[content]']");

        if (categorySelect) {
          categorySelect.value = category;
          categorySelect.dispatchEvent(new Event("change", { bubbles: true }));
        }
        if (titleInput) titleInput.value = title;
        if (contentTextarea) contentTextarea.value = content;

        // Switch to the blank form tab
        const blankFormTab = document.getElementById("profile-tab");
        if (blankFormTab) blankFormTab.click();
      });
    });
  });
</script>
