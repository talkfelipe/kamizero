<%# ============================================================
    BUILD SCHOOL → COLOR MAP (DYNAMIC HSL - INFINITE COLORS)
    FIX 7: Works for BOTH parents AND teachers
           + UNREAD NOTICES events get school colors
           + Case-insensitive category comparison
           + Date pill text colors fixed for school colors
    ============================================================ %>
<%
  # Helper method to generate pastel color from school ID
  def generate_school_color(school_id)
    # Golden angle distribution for good color spacing
    hue = (school_id * 137.508) % 360

    # Adjust hue to prefer cool spectrum with some warm accents
    if hue > 300 || hue < 60
      hue = ((hue % 60) * 0.5) + 15
    elsif hue >= 60 && hue < 180
      hue = ((hue - 60) * 0.5) + 180
    end

    saturation = 55 + (school_id % 15)
    lightness = 70 + (school_id % 10)

    "hsl(#{hue.round}, #{saturation}%, #{lightness}%)"
  end

  # Helper to get darker version for text
  def generate_school_color_dark(school_id)
    hue = (school_id * 137.508) % 360

    if hue > 300 || hue < 60
      hue = ((hue % 60) * 0.5) + 15
    elsif hue >= 60 && hue < 180
      hue = ((hue - 60) * 0.5) + 180
    end

    saturation = 60 + (school_id % 15)
    lightness = 35 + (school_id % 10)

    "hsl(#{hue.round}, #{saturation}%, #{lightness}%)"
  end

  # FIX: Get schools for BOTH parents AND teachers
  school_colors = {}
  schools = []

  if current_user.role == "teacher"
    # Get schools from BOTH events AND unread notices (events only)
    event_schools = @events.present? ? @events.map(&:school).compact : []
    notice_event_schools = @unread_notices.present? ? @unread_notices.select { |n| n.category&.downcase == "event" }.map(&:school).compact : []
    schools = (event_schools + notice_event_schools).uniq
  else
    schools = current_user.children.includes(:school).map(&:school).compact.uniq
  end

  schools.each do |school|
    school_colors[school.id] = {
      light: generate_school_color(school.id),
      dark: generate_school_color_dark(school.id)
    }
  end
%>

<style>
  /* Generate dynamic school color classes */
  <% school_colors.each do |school_id, colors| %>
    /* School ID <%= school_id %> colors */
    .school-tag-<%= school_id %>,
    .calendar-event.school-tag-<%= school_id %> {
      background-color: <%= colors[:light] %> !important;
      color: #ffffff !important;
    }

    .event-date-pill-<%= school_id %> {
      background: linear-gradient(145deg, <%= colors[:light] %> 0%, <%= colors[:dark] %> 100%) !important;
      border: none !important;
    }

    /* FIX: Date pill text must be white when using school colors */
    .event-date-pill-<%= school_id %> .event-month,
    .event-date-pill-<%= school_id %> .event-day {
      color: #ffffff !important;
    }

    .event-title-<%= school_id %> {
      color: <%= colors[:dark] %> !important;
    }
  <% end %>
</style>

<div class="container my-4 dashboard-page">
  <!-- WELCOME CARD -->
  <div class="card dashboard-card mb-4">
    <div class="card-body d-flex align-items-center">
      <div class="welcome-logo-wrapper me-3">
        <%= image_tag "KAMIZERO LOGO MAIN.png", class: "welcome-logo img-fluid" %>
      </div>
      <div class="flex-grow-1">
        <p class="mb-1 kamizero-tagline">
          Managing School Notices Paperlessly
        </p>
      </div>
    </div>
  </div>

  <!-- Dashboard Welcome HEADER -->
  <div class="dashboard-header">
    <p class="mb-0 welcome-user">
      <strong>Welcome, <%= current_user.first_name %>!</strong>
    </p>
    <% if current_user.children.present? %>
      <div class="dashboard-schools mt-1">
        <% current_user.children.each do |student| %>
          <% school = student.school %>
          <p class="mb-0 school-tag school-tag-<%= school.id %>">
            <%= school.name %> School
          </p>
        <% end %>
      </div>
    <% else %>
      <% unless current_user.role == "teacher" %>
        <p class="mb-0 current-subscription">
          No active students yet
        </p>
      <% end %>
    <% end %>
  </div>

  <!-- UNREAD NOTICES + NOTES ROW -->
  <div class="row g-3 mb-4">

    <!-- UNREAD NOTICES CARD (LEFT – 6 COLS) -->
    <div class="col-md-6">
      <div class="card dashboard-card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <i class="fa-solid fa-bell me-2"></i>
            <span class="fw-semibold">NEW NOTICES</span>
            <span class="badge bg-danger ms-2">
              <%= @unread_count_notices || 0 %>
            </span>
          </div>
          <%= link_to "VIEW ALL", notices_path, class: "btn button-view-all btn-sm" %>
        </div>

        <ul class="list-group list-group-flush notices-list">
          <% if @unread_notices.present? %>
            <% @unread_notices.each do |notice| %>
              <li class="list-group-item unread-item">
                <%= link_to notice_path(notice), class: "d-flex w-100 event-item text-decoration-none text-reset" do %>

                  <% if notice.category&.downcase == "event" %>
                    <!-- EVENT NOTICE: Date pill with school color gradient -->
                    <div class="event-date-pill event-date-pill-<%= notice.school_id %> me-3">
                      <div class="event-month"><%= notice.created_at.strftime("%b").upcase %></div>
                      <div class="event-day"><%= notice.created_at.strftime("%-d") %></div>
                    </div>
                  <% else %>
                    <!-- REGULAR NOTICE: Default navy styling -->
                    <div class="event-date-pill me-3">
                      <div class="event-month"><%= notice.created_at.strftime("%b").upcase %></div>
                      <div class="event-day"><%= notice.created_at.strftime("%-d") %></div>
                    </div>
                  <% end %>

                  <!-- TEXT CONTENT -->
                  <div class="event-text flex-grow-1">
                    <% if notice.category&.downcase == "event" %>
                      <!-- EVENT NOTICE: Title with school color -->
                      <div class="event-title event-title-<%= notice.school_id %>"><%= notice.title %></div>
                    <% else %>
                      <!-- REGULAR NOTICE: Default navy title -->
                      <div class="event-title"><%= notice.title %></div>
                    <% end %>

                    <div class="event-meta">
                      <%= notice.created_at.strftime("%A") %>
                      <% if notice.start_time.present? && notice.end_time.present? %>
                        • <%= notice.start_time.strftime("%H:%M") %> - <%= notice.end_time.strftime("%H:%M") %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </li>
            <% end %>
          <% else %>
            <li class="list-group-item text-muted">No notices yet</li>
          <% end %>
        </ul>
      </div>
    </div>

    <!-- NOTES CARD (RIGHT – 6 COLS) -->
    <div class="col-md-6">
      <div class="card dashboard-card notes-card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <i class="fa-solid fa-bell me-2"></i>
              <span class="fw-semibold">MESSAGES</span>
              <span class="badge bg-danger ms-2">
               <%= @unread_count_notes || 0 %>
              </span>
          </div>
          <%= link_to "VIEW ALL", notes_path, class: "btn button-view-all btn-sm" %>
        </div>

        <ul class="list-group list-group-flush notices-list">
          <% if @unread_notes.present? %>
            <% @unread_notes.each do |note| %>
              <li class="list-group-item unread-item">
                <%= link_to note_path(note), class: "d-flex w-100 event-item text-decoration-none text-reset" do %>

                  <!-- DATE PILL -->
                  <div class="event-date-pill me-3">
                    <div class="event-month"><%= note.created_at.strftime("%b").upcase %></div>
                    <div class="event-day"><%= note.created_at.strftime("%-d") %></div>
                  </div>

                  <!-- TEXT CONTENT -->
                  <div class="event-text flex-grow-1">
                    <div class="event-title"><%= note.title %></div>

                    <div class="event-meta">
                      <%= note.created_at.strftime("%A") %></div>
                  </div>
                <% end %>
              </li>
            <% end %>
          <% else %>
            <li class="list-group-item text-muted bg-white">No messages yet</li>
          <% end %>
        </ul>
      </div>
    </div>


  </div>

  <!-- SCROLL TARGET FOR PREVIOUS/TODAY/NEXT -->
  <div id="calendar-section"></div>

  <!-- CALENDAR + MONTHLY EVENTS -->
  <div class="row g-3 mb-4 calendar-events-row">
    <!-- CALENDAR CARD -->
    <div class="col-md-6">
      <div class="card calendar-card h-100">
        <div class="card-header">CALENDAR</div>
        <div class="card-body p-0">
          <%= month_calendar do |date| %>
            <% day_events      = Array(@events_for_day[date]) %>
            <% visible_events  = day_events.first(2) %>
            <% remaining_count = [day_events.size - visible_events.size, 0].max %>

            <div class="calendar-day">
              <!-- DATE (centered via CSS) -->
              <span class="date-number"><%= date.day %></span>

              <!-- EVENTS: start time + title, each on its own line (no wrap to multiple rows per event) -->
              <% visible_events.each do |event| %>
                <% classes = ["calendar-event", "school-tag-#{event.school_id}"] %>

                <%= link_to notice_path(event), class: classes.join(" ") do %>
                  <% label_parts = [] %>
                  <% label_parts << event.start_time.strftime("%H:%M") if event.start_time.present? %>
                  <% label_parts << event.title %>
                  <%= label_parts.join(" ") %>
                <% end %>
              <% end %>

              <!-- "+N more events" line when there are more than 2 -->
              <% if remaining_count.positive? %>
                <div class="calendar-more-events">
                  +<%= remaining_count %> event<%= "s" if remaining_count > 1 %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- MONTHLY EVENTS CARD -->
    <div class="col-md-6">
      <div class="card events-card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>MONTHLY EVENTS</span>
          <%= link_to "VIEW ALL", events_notices_path, class: "btn button-view-all btn-sm" %>
        </div>

        <ul class="list-group list-group-flush events-list">
          <% if @events.present? %>
            <% @events.order(date: :asc).each do |event| %>
              <li class="list-group-item">
                <%= link_to notice_path(event),
                            class: "event-item d-flex w-100 text-decoration-none text-reset" do %>

                  <!-- DATE PILL with school color gradient -->
                  <div class="event-date-pill event-date-pill-<%= event.school_id %> me-3">
                    <div class="event-month">
                      <%= event.date.strftime("%b") %>
                    </div>
                    <div class="event-day">
                      <%= event.date.strftime("%-d") %>
                    </div>
                  </div>

                  <!-- TEXT BLOCK -->
                  <div class="event-text flex-grow-1">
                    <!-- Title with school color -->
                    <div class="event-title event-title-<%= event.school_id %>">
                      <%= event.title %>
                    </div>
                    <div class="event-meta">
                      <% weekday_str = event.date.strftime("%A") %>
                      <% time_str =
                           if event.start_time && event.end_time
                             "#{event.start_time.strftime("%H:%M")} - #{event.end_time.strftime("%H:%M")}"
                           elsif event.start_time
                             event.start_time.strftime("%H:%M")
                           else
                             nil
                           end %>
                      <%= weekday_str %>
                      <% if time_str.present? %>
                        &nbsp;·&nbsp;<%= time_str %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </li>
            <% end %>
          <% else %>
            <li class="list-group-item text-muted">
              No upcoming events yet
            </li>
          <% end %>
        </ul>
      </div>
    </div>
  </div>
</div>
